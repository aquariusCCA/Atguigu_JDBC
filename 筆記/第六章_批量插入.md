# 1. æ‰¹é‡æ‰§è¡ŒSQLè¯­å¥
> å½“éœ€è¦æˆæ‰¹æ’å…¥æˆ–è€…æ›´æ–°è®°å½•æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ Java çš„æ‰¹é‡æ›´æ–°æœºåˆ¶ï¼Œè¿™ä¸€æœºåˆ¶å…è®¸å¤šæ¡è¯­å¥ä¸€æ¬¡æ€§æäº¤ç»™æ•°æ®åº“æ‰¹é‡å¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹æ¯”å•ç‹¬æäº¤å¤„ç†æ›´æœ‰æ•ˆç‡ã€‚

### JDBC çš„æ‰¹é‡å¤„ç†è¯­å¥åŒ…æ‹¬ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•ï¼š
1. addBatch(String)ï¼šæ·»åŠ éœ€è¦æ‰¹é‡å¤„ç†çš„ SQL è¯­å¥æˆ–æ˜¯å‚æ•°
2. executeBatch()ï¼šæ‰§è¡Œæ‰¹é‡å¤„ç†è¯­å¥
3. clearBatch() : æ¸…ç©ºç¼“å­˜çš„æ•°æ®

### é€šå¸¸æˆ‘ä»¬ä¼šé‡åˆ°ä¸¤ç§æ‰¹é‡æ‰§è¡Œ SQL è¯­å¥çš„æƒ…å†µï¼š
1. å¤šæ¡ SQL è¯­å¥çš„æ‰¹é‡å¤„ç†
2. ä¸€ä¸ª SQL è¯­å¥çš„æ‰¹é‡ä¼ å‚

### èªå¥å¾Œé¢ä¸èƒ½æ·»åŠ åˆ†è™Ÿ `;`
åœ¨ JDBC ä¸­ï¼Œ**SQL èªå¥**æœ¬èº«æ˜¯ç›´æ¥äº¤çµ¦è³‡æ–™åº«å»åŸ·è¡Œçš„ã€‚  
å¦‚æœä½ åœ¨ç¨‹å¼ä¸­å¯«çš„ SQL å­—ä¸²æ˜¯é€™æ¨£ï¼š

```java
String sql = "insert into t_user (account,password,nickname) values (?,?,?);";
```

é‚£éº¼ JDBC åœ¨å¾Œç«¯çœŸæ­£å‚³é€çš„ SQL èªå¥æ˜¯åŒ…å« `;` çš„ã€‚  
ä½†æ˜¯ï¼š

- **JDBC** å’Œ **MySQL JDBC Driver**ï¼ˆåƒ `com.mysql.cj.jdbc.Driver`ï¼‰åœ¨é€²è¡Œ **æ‰¹é‡å„ªåŒ–**ï¼ˆ`rewriteBatchedStatements=true`ï¼‰çš„æ™‚å€™ï¼Œ
- å®ƒå€‘æœƒæŠŠå¤šå€‹ SQL æ‹¼æˆä¸€æ¢å¤§èªå¥ï¼Œä¾‹å¦‚ï¼š

  ```sql
  insert into t_user (account,password,nickname) values ('a','b','c'),('d','e','f'),('g','h','i')
  ```

é€™æ¨£å¯ä»¥ä¸€æ¬¡æ’å…¥å¤šç­†æ•¸æ“šï¼Œæé«˜æ•ˆç‡ï¼ˆé¿å…å¤šæ¬¡ç¶²è·¯å‚³è¼¸ï¼‰ã€‚

ğŸ”µ **å¦‚æœ SQL å­—ä¸²è£¡æœ‰åˆ†è™Ÿ**ï¼š

- JDBC é©…å‹•å™¨åœ¨ã€Œæ‹¼æ¥ã€çš„æ™‚å€™ç„¡æ³•æ­£å¸¸çµ„åˆï¼Œå› ç‚º **åˆ†è™Ÿè¡¨ç¤ºçµæŸèªå¥**ï¼
- ä¾‹å¦‚ï¼š

  ```sql
  insert into t_user (account,password,nickname) values ('a','b','c');insert into t_user (account,password,nickname) values ('d','e','f');
  ```

é€™ä¸æ˜¯ä¸€æ¢èªæ³•æ­£ç¢ºçš„ SQLï¼Œè€Œæ˜¯å…©æ¢åˆ†é–‹çš„èªå¥ï¼Œæœƒå°è‡´**æ‰¹é‡åŸ·è¡Œå¤±æ•—**ï¼

âœ… ç°¡å–®èªªï¼š
- **æ‰¹é‡æ™‚ï¼Œæ¯å€‹ SQL èªå¥ä¸èƒ½å¸¶åˆ†è™Ÿï¼›ä¸ç„¶æœƒç ´å£æ‹¼æ¥é‚è¼¯ï¼**
- **å–®æ¢åŸ·è¡Œçš„æ™‚å€™å¯ä»¥åŠ ï¼Œä½†æ‰¹é‡æ“ä½œæ™‚ç¦æ­¢ã€‚**

# 2. é«˜æ•ˆçš„æ‰¹é‡æ’å…¥
## æ•°æ®åº“ä¸­æä¾›ä¸€ä¸ª goods è¡¨ã€‚åˆ›å»ºå¦‚ä¸‹ï¼š

```sql
CREATE TABLE goods(
    id INT PRIMARY KEY AUTO_INCREMENT,
    NAME VARCHAR(20)
);
```

## ä¸¾ä¾‹ï¼šå‘æ•°æ®è¡¨ä¸­æ’å…¥ 20000 æ¡æ•°æ®

### å®ç°å±‚æ¬¡ä¸€ï¼šä½¿ç”¨ Statement

```java
@Test
public void testInsert1() throws Exception{
    long start = System.currentTimeMillis();
    Connection conn = JDBCUtils.getConnection();
    Statement st = conn.createStatement();
    for(int i = 1;i <= 20000;i++){
        String sql = "insert into goods(name) values('name_" + i + "')";
        st.executeUpdate(sql);
    }
    long end = System.currentTimeMillis();
    System.out.println("èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š" + (end - start));
}
```

### å®ç°å±‚æ¬¡äºŒï¼šä½¿ç”¨ PreparedStatement
> ç›¸å°æ–¼æ–¹å¼ä¸€ä¾†èªª, æ–¹å¼äºŒçš„æ•ˆç‡è‚¯å®šæ˜¯æ¯”è¼ƒå¥½çš„å› ç‚º Statement æ¯æ¬¡éƒ½è¦åŠ è¼‰æ–°çš„ sql èªå¥ï¼Œè€Œ PreparedStatement éƒ½æ˜¯ä½¿ç”¨åŒä¸€å€‹æ¨¡æ¿ï¼Œè®Šå‹•çš„åªæœ‰ä½”ä½ç¬¦ã€‚

```java
@Test
public void testInsert2() {
    Connection conn = null;
    PreparedStatement ps = null;
    try {
        long start = System.currentTimeMillis();

        conn = JDBCUtils.getConnection();

        String sql = "insert into goods(name)values(?)";
        ps = conn.prepareStatement(sql);
        for (int i = 1; i <= 20000; i++) {
            ps.setObject(1, "name_" + i);

            ps.execute();
        }

        long end = System.currentTimeMillis();
        System.out.println("èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š" + (end - start)); // 50102
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        JDBCUtils.closeResource(conn, ps);
    }
}
```

### å®ç°å±‚æ¬¡ä¸‰ : ä½¿ç”¨ addBatch()ã€executeBatch()ã€clearBatch()
> mysql æœåŠ¡å™¨é»˜è®¤æ˜¯å…³é—­æ‰¹å¤„ç†çš„ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªå‚æ•°ï¼Œè®© mysql å¼€å¯æ‰¹å¤„ç†çš„æ”¯æŒã€‚ 
>
> â€‹	å°‡ `?rewriteBatchedStatements=true` å†™åœ¨é…ç½®æ–‡ä»¶çš„ url åé¢ã€‚

```java
@Test
public void testInsert3() {
    Connection conn = null;
    PreparedStatement ps = null;
    try {
        long start = System.currentTimeMillis();

        conn = JDBCUtils.getConnection();

        String sql = "insert into goods(name) values(?)";
        ps = conn.prepareStatement(sql);

        for (int i = 1; i <= 1000000; i++) {
            ps.setObject(1, "name_" + i);

            //1."ç©æ”¢"sql
            ps.addBatch();

            if (i % 500 == 0) {
                //2.æ‰§è¡Œbatch
                ps.executeBatch();

                //3.æ¸…ç©ºbatch
                ps.clearBatch();
            }
        }

        long end = System.currentTimeMillis();
        System.out.println("èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š" + (end - start)); // 19509
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        JDBCUtils.closeResource(conn, ps);
    }
}
```

### å®ç°å±‚æ¬¡å›› : è®¾ç½®è¿æ¥ä¸å…è®¸è‡ªåŠ¨æäº¤æ•°æ®
```java
@Test
public void testInsert4() {
    Connection conn = null;
    PreparedStatement ps = null;
    try {
        long start = System.currentTimeMillis();

        conn = JDBCUtils.getConnection();

        //è®¾ç½®ä¸å…è®¸è‡ªåŠ¨æäº¤æ•°æ®
        conn.setAutoCommit(false);

        String sql = "insert into goods(name)values(?)";
        ps = conn.prepareStatement(sql);
        for (int i = 1; i <= 1000000; i++) {
            ps.setObject(1, "name_" + i);

            //1."æ”’"sql
            ps.addBatch();

            if (i % 500 == 0) {
                //2.æ‰§è¡Œbatch
                ps.executeBatch();

                //3.æ¸…ç©ºbatch
                ps.clearBatch();
            }
        }

        //æäº¤æ•°æ®
        conn.commit();

        long end = System.currentTimeMillis();
        System.out.println("èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š" + (end - start)); // 11280
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        JDBCUtils.closeResource(conn, ps);
    }
}
```

